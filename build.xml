<?xml version="1.0" encoding="UTF-8"?>
<!--
Copyright (C) 2011 CRS4.

This file is part of Seal.

Seal is free software: you can redistribute it and/or modify it
under the terms of the GNU General Public License as published by the Free
Software Foundation, either version 3 of the License, or (at your option)
any later version.

Seal is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
for more details.

You should have received a copy of the GNU General Public License along
with Seal.  If not, see <http://www.gnu.org/licenses/>.
-->

<project name="seal" default="package" basedir=".">
	<!-- user directories -->
	<property name="src.dir" value="src" />
	<property name="test.dir" value="tests" />
	<property name="lib.dir" value="lib" />
	<property name="build.dir" value="classes" />
	<property name="test.build.dir" value="test-${build.dir}" />
	<property name="jar.file" value="build/${ant.project.name}.jar" />
	<condition property="debug.build" value="false">
		<not>  
			<isset property="debug.build"/>
		</not>
	</condition>
	
	<!-- extra properties -->
	<property environment="env"/>
	<property name="hadoop.dir" value="${env.HADOOP_HOME}" />
	<property name="jars.override" value="" />

	<fileset id="hadoop_jars" dir="${hadoop.dir}">
		<include name="hadoop-*.jar"/>
		<include name="lib/commons-cli-1.2.jar"/>
		<include name="lib/commons-logging-*.jar"/>
	</fileset>

	<fileset id="junit_jars_ubuntu" dir="/usr/share/java">
		<include name="junit4.jar"/>
		<include name="hamcrest-*.jar"/>
	</fileset>

	<fileset id="junit_jars_gentoo" dir="/">
		<include name="/usr/share/junit-4/lib/*.jar"/>
		<include name="/usr/share/hamcrest-core/lib/*.jar" />
	</fileset>

	<fileset id="jars_override" dir="/">
		<include name="${jars.override}" />
	</fileset>

	<!-- tasks -->
	<target name="clean">
		<delete failonerror="false" dir="${build.dir}"/>
		<delete failonerror="false" dir="${test.build.dir}"/>
		<delete failonerror="false" file="${jar.file}" />
	</target>
	
	<target name="compile">
		<mkdir dir="${build.dir}"/>
		<javac srcdir="${src.dir}" destdir="${build.dir}" includeAntRuntime="false" debug="${debug.build}">
			<classpath>
				<fileset refid="hadoop_jars"/>
			</classpath>
			<compilerarg value="-Xlint"/>
		</javac>
	</target>

	<target name="package" depends="compile">
		<dirname property="package.dir" file="${jar.file}" />
		<mkdir dir="${package.dir}" />
		<jar destfile="${jar.file}" basedir="${build.dir}" manifest="${src.dir}/MANIFEST.MF" />
	</target>

	<target name="build-tests" depends="compile">
		<mkdir dir="${test.build.dir}"/>
		<javac srcdir="${test.dir}" destdir="${test.build.dir}" includeAntRuntime="false" debug="true">
			<classpath>
				<pathelement path="${build.dir}"/>
				<fileset refid="hadoop_jars"/>
				<fileset refid="jars_override" />
				<fileset refid="junit_jars_ubuntu" />
				<fileset refid="junit_jars_gentoo" />
			</classpath>
			<compilerarg value="-Xlint"/>
		</javac>
	</target>	

	<target name="run-tests" depends="build-tests">
		<junit showoutput="true">
			<classpath>
				<pathelement path="${build.dir}"/>
				<pathelement path="${test.build.dir}"/>
				<fileset refid="hadoop_jars"/>
				<fileset refid="jars_override" />
				<fileset refid="junit_jars_ubuntu" />
				<fileset refid="junit_jars_gentoo" />
			</classpath>
			<formatter type="brief" usefile="false"/>
			<batchtest>
				<fileset dir="${test.build.dir}">
					 <include name="**/Test*.class" />
				</fileset>
			</batchtest>
		</junit> 
	</target>
  
  <target name="prq_integration_tests" depends="package">
    <exec executable="tests/prq_integration_tests/run.sh" />
  </target>

	<target name="all" depends="clean,package,run-tests" />
</project>
