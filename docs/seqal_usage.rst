Usage
=====

Like BWA, Seqal takes as input read pairs to be aligned, and an indexed 
reference sequence.  The input read pairs need to be in ``prq`` format [1]_ (PairReadsQSeq
may help you format them quickly), and they need to be located on an HDFS
volume. The indexed reference is a slightly modified version of the one
generated by BWA.  See the following section for instructions.

Preparing the reference index archive
-------------------------------------

Seqal needs a modified version of the BWA index files to run.  To created it
follow these steps:

#. Generate the standard bwa index::

    bwa index [OPTIONS] ref.fa

#. Modify it::

    ./bin/bwa_index_to_mmap ref.fa
    
   This generates two new files:  ref.fa.sax and ref.fa.rsax.

#. Delete the original ``.sa`` and ``.rsa`` files::

    rm -f ref.fa.*sa
    
   These two files are not required by Seqal.

#. Build an archive containing the index files at the top level::

    tar cf ref.tar ref.fa.*

Hadoop's distributed cache mechanism will be used to distribute and unpack the
archive on all the cluster nodes.  We recommend not including the original
``.sa`` and ``.rsa`` files since for a full human genome reference they are
large enough to slow the distribution process by a few minutes.  Also, we
recommend not compressing the archive since we have found that decompressing it
adds several minutes to the start-up time, even if copying the file may be
faster.  Using a light compression (e.g. ``gzip --fast``) may be the optimal
solution but we have yet to test it.


Running the application
-----------------------

To run seqal, use the ``bin/run_seqal.sh`` command under the distribution root.
The command takes the following arguments:

#. Input path (a file or a directory), containing paired sequence data in prq
   format.  If the path references a directory, then all the files inside it
   will be processed.

#. Output directory, where results in SAM format will be written.

#. Reference index archive (see previous section).

All paths reference files or directories on an HDFS volume, and are optionally 
relative to the current user's HDFS home directory (i.e.,
``/user/<USERNAME>``).

Settings
..........

You may want to edit some of the settings found at the end of ``run_seqal.sh``.
For a full description of the options currently available see the
options_ page.

Hadoop
........

Finally, we recommend you set the HADOOP_HOME environment variable to
point to your Hadoop installation; as an alternative, ensure that the 
``hadoop`` executable is in your ``PATH``.
In addition, if you use a non-standard Hadoop configuration directory,
the ``HADOOP_CONF_DIR`` environment variable has to be set to point to
that directory.

For instance, if Hadoop is installed in ``/opt/hadoop`` and its
configuration directory is in ``/etc/hadoopconf``::

 export HADOOP_HOME="/opt/hadoop"
 export HADOOP_CONF_DIR="/etc/hadoopconf"

.. [1] See the "File Formats" page in the PairReadsQSeq documentation.
.. _options:  options.html
